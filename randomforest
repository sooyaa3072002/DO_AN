https://colab.research.google.com/drive/1RgbfzPmgDXJS7k4TS2916olh74Zh7v05?usp=sharing

import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score, classification_report, confusion_matrix
import matplotlib.pyplot as plt
import seaborn as sns
from google.colab import files

# 1. Upload file dá»¯ liá»‡u
print("Vui lÃ²ng táº£i lÃªn tá»‡p CSV cá»§a báº¡n...")
uploaded = files.upload()
file_name = list(uploaded.keys())[0]
file_path = f"/content/{file_name}"

# 2. Äá»c dá»¯ liá»‡u
df = pd.read_csv(file_path)

# 3. Kiá»ƒm tra dá»¯ liá»‡u
print("\n==== ThÃ´ng tin dá»¯ liá»‡u ====")
print(df.info())
print("\n==== 5 dÃ²ng Ä‘áº§u ====")
print(df.head())
print("\n==== PhÃ¢n phá»‘i action ====")
print(df["action"].value_counts())


# Trung bÃ¬nh PV_Power_kW trong 12 giá» trÆ°á»›c
df["pvAvg12h"] = df["PV_Power_kW"].rolling(window=12, min_periods=1).mean().shift(1)

# Trung bÃ¬nh Gia_mua_dien trong 12 giá» trÆ°á»›c
df["priceAvg12h"] = df["Gia_mua_dien"].rolling(window=12, min_periods=1).mean().shift(1)

# Trung bÃ¬nh Load_Power_kW trong 12 giá» trÆ°á»›c
df["loadAvg12h"] = df["Load_Power_kW"].rolling(window=12, min_periods=1).mean().shift(1)

# Xá»­ lÃ½ giÃ¡ trá»‹ NaN
df.fillna(0, inplace=True)

# 5. Chá»n Ä‘áº·c trÆ°ng vÃ  nhÃ£n
feature_cols = [
     "PV_Power_kW", "Load_Power_kW",
    "SOC_kWh", "Gia_mua_dien", "Gia_ban_dien", "pvAvg12h", "priceAvg12h", "loadAvg12h"
]
X = df[feature_cols]
y = df["action"]

# 6. Chia táº­p huáº¥n luyá»‡n vÃ  kiá»ƒm tra
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# 7. Huáº¥n luyá»‡n mÃ´ hÃ¬nh Random Forest
model = RandomForestClassifier(n_estimators=100, max_depth=10, random_state=42, class_weight='balanced')
model.fit(X_train, y_train)

# 8. Dá»± Ä‘oÃ¡n trÃªn táº­p kiá»ƒm tra
y_pred = model.predict(X_test)

# 9. ÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh
print("\n==== BÃ¡o CÃ¡o PhÃ¢n Loáº¡i ====")
print(classification_report(y_test, y_pred, target_names=["Idle (0)", "Charge (1)", "Discharge (2)"]))
print("Äá»™ chÃ­nh xÃ¡c tá»•ng thá»ƒ:", accuracy_score(y_test, y_pred))

# Ma tráº­n nháº§m láº«n
print("\n==== Ma Tráº­n Nháº§m Láº«n ====")
conf_matrix = confusion_matrix(y_test, y_pred)
print(conf_matrix)

# 10. Trá»±c quan hÃ³a ma tráº­n nháº§m láº«n
plt.figure(figsize=(6, 4))
sns.heatmap(conf_matrix, annot=True, fmt='d', cmap='Blues',
            xticklabels=["Idle", "Charge", "Discharge"],
            yticklabels=["Idle", "Charge", "Discharge"])
plt.xlabel("Dá»± Ä‘oÃ¡n")
plt.ylabel("Thá»±c táº¿")
plt.title("Ma Tráº­n Nháº§m Láº«n")
plt.tight_layout()
plt.show()

# 11. Táº§m quan trá»ng cá»§a Ä‘áº·c trÆ°ng
importances = model.feature_importances_
feat_imp_df = pd.DataFrame({'Feature': feature_cols, 'Importance': importances})
feat_imp_df.sort_values(by="Importance", ascending=False, inplace=True)

print("\n==== Táº§m Quan Trá»ng Äáº·c TrÆ°ng ====")
print(feat_imp_df)

# Trá»±c quan hÃ³a táº§m quan trá»ng Ä‘áº·c trÆ°ng
plt.figure(figsize=(10, 6))
sns.barplot(x="Importance", y="Feature", data=feat_imp_df)
plt.title("Táº§m Quan Trá»ng Cá»§a CÃ¡c Äáº·c TrÆ°ng")
plt.tight_layout()
plt.show()

# 12. Dá»± Ä‘oÃ¡n trÃªn dá»¯ liá»‡u máº«u
# Dá»¯ liá»‡u máº«u vá»›i cÃ¡c giÃ¡ trá»‹ há»£p lÃ½ dá»±a trÃªn dá»¯ liá»‡u gá»‘c
data_samples = pd.DataFrame({
    "PV_Power_kW": [1, 5, 0],
    "Load_Power_kW": [1, 3, 2],
    "SOC_kWh": [5, 12, 8],
    "Gia_mua_dien": [3007, 5174, 5174],
    "Gia_ban_dien": [671, 671, 671],
    "pvAvg12h": [1.5, 3.5, 2.0],
    "priceAvg12h": [2500, 4500, 4800],
    "loadAvg12h": [1.2, 2.5, 2.0]
})

# Dá»± Ä‘oÃ¡n hÃ nh Ä‘á»™ng
predictions = model.predict(data_samples)

# In káº¿t quáº£ dá»± Ä‘oÃ¡n
print("\n==== Dá»± ÄoÃ¡n TrÃªn Dá»¯ Liá»‡u Máº«u ====")
action_map = {0: "Idle", 1: "Charge", 2: "Discharge"}
for i, pred in enumerate(predictions):
    print(f"VÃ­ dá»¥ {i+1}: Dá»± Ä‘oÃ¡n hÃ nh Ä‘á»™ng = {action_map[pred]}")
  # 13. Dá»± Ä‘oÃ¡n hÃ nh Ä‘á»™ng trÃªn dá»¯ liá»‡u CSV má»›i



from google.colab import files
import pandas as pd

# BÆ°á»›c 1: Upload file má»›i
print("\nğŸ“‚ Vui lÃ²ng táº£i lÃªn tá»‡p CSV dá»¯ liá»‡u má»›i Ä‘á»ƒ dá»± Ä‘oÃ¡n hÃ nh Ä‘á»™ng...")
new_uploaded = files.upload()
new_file_name = list(new_uploaded.keys())[0]
new_file_path = f"/content/{new_file_name}"

# BÆ°á»›c 2: Äá»c dá»¯ liá»‡u Excel
new_df = pd.read_excel(new_file_path)
# BÆ°á»›c 3: Tiá»n xá»­ lÃ½ dá»¯ liá»‡u giá»‘ng nhÆ° dá»¯ liá»‡u huáº¥n luyá»‡n
new_df["pvAvg12h"] = new_df["PV_Power_kW"].rolling(window=12, min_periods=1).mean().shift(1)
new_df["priceAvg12h"] = new_df["Gia_mua_dien"].rolling(window=12, min_periods=1).mean().shift(1)
new_df["loadAvg12h"] = new_df["Load_Power_kW"].rolling(window=12, min_periods=1).mean().shift(1)
new_df.fillna(0, inplace=True)

# BÆ°á»›c 4: Láº¥y Ä‘áº·c trÆ°ng
X_new = new_df[feature_cols]

# BÆ°á»›c 3: Dá»± Ä‘oÃ¡n hÃ nh Ä‘á»™ng
X_new = new_df[feature_cols]  # Ä‘áº£m báº£o feature_cols Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a tá»« trÆ°á»›c
new_predictions = model.predict(X_new)

# BÆ°á»›c 4: Gáº¯n nhÃ£n káº¿t quáº£
action_map = {0: "Idle", 1: "Charge", 2: "Discharge"}
new_df["Predicted_Action"] = [action_map[pred] for pred in new_predictions]

# BÆ°á»›c 5: Hiá»ƒn thá»‹ káº¿t quáº£
print("\nâœ… Káº¿t quáº£ dá»± Ä‘oÃ¡n hÃ nh Ä‘á»™ng:")
print(new_df[["Hour", "PV_Power_kW", "Load_Power_kW", "SOC_kWh", "Gia_mua_dien", "Predicted_Action"]].head())

# BÆ°á»›c 6: LÆ°u káº¿t quáº£ ra file CSV
output_path = "/content/du_doan_hanh_dong.csv"
new_df.to_csv(output_path, index=False)
print(f"ğŸ’¾ Káº¿t quáº£ Ä‘Ã£ Ä‘Æ°á»£c lÆ°u vÃ o: {output_path}")
